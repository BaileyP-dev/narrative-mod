<!-- DO NOT REMOVE THE FOLLOWING COMMENT -->
<!-- (c) Copyright 2014 Caroline Hill. All Rights Reserved. Contact Mlle Caroline Schnapp at mllegeorgesand@gmail.com -->
<!-- DO NOT REMOVE THE ABOVE COMMENT -->

<!-- DIEN MOD -->
<!-- Heavily modified the original version by Caroline Hill to add: -->
<!-- + Support for both "regular" cart and cart drawer -->
<!-- + Support for two cost models (settable in theme's general settings): 1) per item and 2) fixed cost -->
<!-- + Auto adjustment of gift wrap item count when number of items in cart changes (applies to per-item cost model only) -->
<!-- + Auto removal of gift wrap item if all other items in cart are removed -->
<!-- + Autosave of gift-wrap note -->
{% if linklists.gift-wrapping.links.size > 0 and linklists.gift-wrapping.links.first.type == 'product_link' %}
  <div id="is-a-gift" style="clear: left; margin: 30px 0" class="clearfix rte">
    <p>
      <input type="hidden" name="attributes[gift-wrapping]" value="" />
      <input id="gift-wrapping" type="checkbox" name="attributes[gift-wrapping]" value="yes" {% if cart.attributes.gift-wrapping %} checked="checked"{% endif %} style="float: none" />
      <label for="gift-wrapping" style="display:inline; padding-left: 5px; float: none;">
        For {{ linklists.gift-wrapping.links.first.object.price | money }}{% if settings.gift_wrapping_cost_model == 'per_item' %} per item{% endif %},
        please wrap the products in this order.
      </label>
    </p>
    <p>
      <label style="display:block" for="gift-note">Gift message (free and optional):</label>
      <textarea name="attributes[gift-note]" id="gift-note">{{ cart.attributes.gift-note }}</textarea>
    </p>
  </div>

  {% assign id = linklists.gift-wrapping.links.first.object.variants.first.id %}

  {% assign gift_wraps_in_cart = 0 %}
  {% for item in cart.items %}
    {% if item.id == id %}
      {% assign gift_wraps_in_cart = item.quantity %}
      {% assign gift_wraps_in_cart_key = item.key %}
    {% endif %}
  {% endfor %}
  {% assign items_in_cart = cart.item_count | minus: gift_wraps_in_cart %}

  {% assign gift_wrap_checkbox_id = '#gift-wrapping' %}
  {% if settings.show_cart_drawer %}
    {% assign cart_container_selector = 'div.cart-drawer__item-list' %}
    {% assign cart_item_quantity_selector = 'input.cart-drawer__item-quantity' %}
    {% assign cart_subtotal_selector = 'span.cart-drawer__subtotal-number' %}
    {% assign cart_discount_selector = 'span[data-cart-total-discount]' %}
    {% assign cart_remove_btn_selector = 'button.cart-drawer__item-delete' %}
  {% else %}
    {% assign cart_container_selector = 'tbody[data-cart-item-list]' %}
    {% assign cart_item_quantity_selector = 'input.cart-item__qty-input' %}
    {% assign cart_subtotal_selector = 'span.cart-footer__subtotal' %}
    {% assign cart_discount_selector = '' %}
    {% assign cart_remove_btn_selector = 'a.cart-item__remove' %}
  {% endif %}

  <style>
    #updates_{{ id }} { display: none; }
  </style>

  <script>
      Shopify.Cart = Shopify.Cart || {};
      Shopify.Cart.DOM = Shopify.Cart.DOM || {};

      jQuery(function () {
          "use strict";
          var SELECTORS = {
              gift_wrap_checkbox : '{{ gift_wrap_checkbox_id }}',
              cart_container : '{{ cart_container_selector }}',
              cart_item_quantity : '{{ cart_item_quantity_selector }}',
              cart_subtotal : '{{ cart_subtotal_selector }}',
              cart_discount : '{{ cart_discount_selector }}',
              cart_remove_btn : '{{ cart_remove_btn_selector }}'
          };

          // Count items in cart (excludes gift-wrap)
          Shopify.Cart.countNoGW = function (gwKey) {
              var itemsInCart = 0;
              // Count total qty in cart for items that are not the gift wrap product
              $(SELECTORS.cart_item_quantity).each(function addItems() {
                  // If gift-wrap product is in cart, then don't count its quantity
                  if (gwKey && this.id.includes(gwKey)) {
                      return;
                  }
                  itemsInCart += (+this.value);
              });

              return itemsInCart;
          };

          Shopify.Cart.DOM.init = function (observerCallback) {
              (typeof observerCallback === 'function') && (this.observerItemList = new MutationObserver(observerCallback));
          };

          Shopify.Cart.DOM.addGWItem = function (addGWItemCb) {
              addGWItemCb = (typeof addGWItemCb === 'function') ? addGWItemCb : function () {};
              // Retrieves "Gift Wrap Stub" page from the "Gift Wrapping" menu.
              // The page contains the generated HTML node of the Gift Wrap line item to be inserted in the Cart Drawer.
              // It also includes elements with the updated subtotal and discount.
              jQuery.ajax({
                  method: 'GET',
                  url: '{{ linklists.gift-wrapping.links[1].url }}',
                  dataType: "html"
              })
              .done(addGWItemCb);
          };

          Shopify.Cart.DOM.removeGWItem = function (gwKey) {
              this.removeSensors(gwKey);
              // Trigger Remove button to delete Gift Wrap item
              gwKey && jQuery('#' + gwKey + ' ' + SELECTORS.cart_remove_btn).trigger('click');
          };

          // Attention: Call this only when GW item is indeed present in the Cart
          // since it attaches a listener directly to the GW item remove button
          Shopify.Cart.DOM.attachSensors = function (gwKey, inputChangeCb, removeBtnCb) {
              var target = document.querySelector(SELECTORS.cart_container);
              var config = { childList: true };
              // Activate observer for cart's item removal or addition, enabling auto-refresh of GW qty
              this.observerItemList && this.observerItemList.observe(target, config);
              // Attach listener for qty input element change of each item, enabling auto-refresh of GW qty
              (typeof inputChangeCb === 'function') && jQuery(SELECTORS.cart_container).on('change.updateGiftWrapQuantity', SELECTORS.cart_item_quantity, inputChangeCb);
              // Attach listener to Gift Wrap item's remove button
              gwKey && (typeof removeBtnCb === 'function') && jQuery('#' + gwKey).on('click.removeGWLineItem', SELECTORS.cart_remove_btn, removeBtnCb);
          };

          Shopify.Cart.DOM.removeSensors = function (gwKey) {
              this.observerItemList && this.observerItemList.disconnect();
              jQuery(SELECTORS.cart_container).off('change.updateGiftWrapQuantity', SELECTORS.cart_item_quantity);
              gwKey && jQuery('#' + gwKey).off('click.removeGWLineItem', SELECTORS.cart_remove_btn);
          };

          Shopify.Cart.GiftWrap = (function () {
              var _quantity = 0;
              const _costModel = '{{ settings.gift_wrapping_cost_model | default: "per_item" }}';

              function getQuantity() {
                  return _quantity;
              }

              function _setQuantity(q) {
                  if (typeof q === 'number') {
                      _quantity = q;
                  }
              }

              function getCostModel() {
                  return _costModel;
              }

              function init(quantity) {
                  _setQuantity(quantity);
              }

              // Parameterized the function
              // Save gift-note
              function set(numItems, callback) {
                  function defaultSuccess() { location.href = '/cart'; }
                  var note = jQuery('#gift-note').val();
                  var done = (typeof callback === 'function') ? callback : defaultSuccess;
                  jQuery.ajax({
                      type: 'POST',
                      url: '/cart/update.js',
                      data: {
                          updates: { {{ id }}: numItems },
                          attributes: { 'gift-wrapping': 'true', 'gift-note': note }
                      },
                      dataType: 'json',
                      success: function() {
                          _setQuantity(numItems);
                          done();
                      }
                  });
              }

              // Parameterized the function
              function remove(callback) {
                  function defaultSuccess() { location.href = '/cart'; }
                  var done = (typeof callback === 'function') ? callback : defaultSuccess;
                  jQuery.ajax({
                      type: 'POST',
                      url: '/cart/update.js',
                      data: {
                          updates: { {{ id }}: 0 },
                          attributes: { 'gift-wrapping': '' }
                      },
                      dataType: 'json',
                      success: function () {
                          _setQuantity(0);
                          done();
                      }
                  });
              }

              return {
                  getCostModel: getCostModel,
                  getQuantity: getQuantity,
                  set: set,
                  remove: remove,
                  init: init
              };
          })(); //IIFE returning a GiftWrap object

          Shopify.Cart.GiftWrap.DOM = (function () {
              var _key = '';
              var _keyEscaped = '';

              function setKey(k) {
                  if (typeof k !== 'undefined' && k !== null) {
                      _key = String(k);
                      _keyEscaped = jQuery.escapeSelector(_key);
                  }
              }

              function getKey() {
                  return _key;
              }

              function getKeyEscaped() {
                  return _keyEscaped;
              }

              function init(key) {
                  this.setKey(key);
              }

              function reset() {
                  this.setKey('');
              }

              function setVal(value) {
                  var key = this.getKeyEscaped();
                  // The id changes from updates_<key> to quantity_<key> after cart refresh with Theme Narrative (bug)!!!
                  if (key) {
                      jQuery('#quantity_' + key).val(value);
                      jQuery('#updates_' + key).val(value);
                  }
              }
              function getVal() {
                  var key = this.getKeyEscaped();
                  // The id changes from updates_<key> to quantity_<key> after cart refresh with Theme Narrative (bug)!!!
                  if (key) {
                      return (jQuery('#quantity_' + key).val() || jQuery('#updates_' + key).val());
                  }

                  return null;
              }
              return {
                  init: init,
                  reset: reset,
                  setVal: setVal,
                  getVal: getVal,
                  setKey: setKey,
                  getKey: getKey,
                  getKeyEscaped: getKeyEscaped
              }
          })(); //IIFE returning GiftWrap.DOM object

      {% unless settings.show_cart_drawer %}
          // If we have nothing but gift-wrap items in the cart.
          {% if cart.items.size == 1 and gift_wraps_in_cart > 0 %}
          jQuery(function () {
              Shopify.Cart.GiftWrap.remove();
          });
          // If we don't have the right amount of gift-wrap items in the cart.
          {% elsif gift_wraps_in_cart > 0 and gift_wraps_in_cart != items_in_cart %}
          jQuery(function () {
              Shopify.Cart.GiftWrap.set();
          });
          // If we have a gift-wrap item in the cart but our gift-wrapping cart attribute has not been set.
          {% elsif gift_wraps_in_cart > 0 and cart.attributes.gift-wrapping == blank %}
          jQuery(function () {
              Shopify.Cart.GiftWrap.set();
          });
          // If we have no gift-wrap item in the cart but our gift-wrapping cart attribute has been set.
          {% elsif gift_wraps_in_cart == 0 and cart.attributes.gift-wrapping != blank %}
          jQuery(function () {
              Shopify.Cart.GiftWrap.set();
          });
          {% endif %}
      {% endunless %}

          function handleRemoveGWBtn() {
              Shopify.Cart.DOM.removeSensors(Shopify.Cart.GiftWrap.DOM.getKeyEscaped());
              // Note: this does NOT trigger the "change" event on the GW checkbox
              jQuery(SELECTORS.gift_wrap_checkbox).prop('checked', false);
              Shopify.Cart.GiftWrap.remove($.noop);
              Shopify.Cart.GiftWrap.DOM.reset();
          }

          // Update gift wrap quantity to match total items quantity in cart
          function updateGiftWrapQuantity() {
              var gwKey = Shopify.Cart.GiftWrap.DOM.getKey();
              var itemsInCart = Shopify.Cart.countNoGW(gwKey);
              if (itemsInCart > 0) {
                  {% if settings.gift_wrapping_cost_model == 'per_item' %}
                  Shopify.Cart.GiftWrap.set(itemsInCart, function () {
                      Shopify.Cart.GiftWrap.DOM.setVal(itemsInCart);
                  });
                  {% else %}
                  // gift wrapping cost model is "fixed_cost"
                  if (Shopify.Cart.GiftWrap.getQuantity() !== 1) {
                      Shopify.Cart.GiftWrap.set(1, function () {
                          Shopify.Cart.GiftWrap.DOM.setVal(1);
                      });
                  }
                  {% endif %}
              }
              else { // No product item in cart, remove GW item from cart
                  let gwSelector = Shopify.Cart.GiftWrap.DOM.getKeyEscaped();
                  gwSelector && jQuery('#' + gwSelector + ' ' + SELECTORS.cart_remove_btn).trigger('click');
              }
          }

          // Callback for MutationObserver to monitor node addition/removal in cart's item list
          // and refresh the Gift Wrap item count accordingly
          function observeItemList(mutations) {
              var changed = mutations.some(function inspectMutation(m) {
                  if (m.type === 'childList') {
                      if (m.addedNodes.length || m.removedNodes.length) {
                          if (m.target === document.querySelector(SELECTORS.cart_container)) {
                              return true;
                          }
                      }
                  }
                  return false;
              });

              changed && updateGiftWrapQuantity();
          }

          function insertGWItemToCartDrawer(htmlStr) {
              var stubHTML = jQuery(htmlStr);
              var giftWrapLineItem = stubHTML[0];
              var newSubtotalSpan = stubHTML[1];
              var newTotalDiscountSpan = stubHTML[2];

              // Add GW item to Cart Drawer in DOM
              jQuery(SELECTORS.cart_container).prepend(giftWrapLineItem);
              // Update total and discount values in DOM
              jQuery(SELECTORS.cart_subtotal).text(newSubtotalSpan.innerText);
              jQuery(SELECTORS.cart_discount).text(newTotalDiscountSpan.innerText);

              // Save gift wrap cart item key
              Shopify.Cart.GiftWrap.DOM.init(giftWrapLineItem.id);
              var key = Shopify.Cart.GiftWrap.DOM.getKeyEscaped();
              {% if settings.gift_wrapping_cost_model == 'per_item' %}
                  Shopify.Cart.DOM.attachSensors(key, updateGiftWrapQuantity, handleRemoveGWBtn);
              {% else %}
                  Shopify.Cart.DOM.attachSensors(key, null, handleRemoveGWBtn);
              {% endif %}
          }

          Shopify.Cart.DOM.init(observeItemList);

          if (jQuery(SELECTORS.gift_wrap_checkbox).prop('checked')) {
              Shopify.Cart.GiftWrap.init({{ items_in_cart | default: 0 }});
              Shopify.Cart.GiftWrap.DOM.init('{{ gift_wraps_in_cart_key | default: "" }}');
              updateGiftWrapQuantity();
              let key = Shopify.Cart.GiftWrap.DOM.getKeyEscaped();
              {% if settings.gift_wrapping_cost_model == 'per_item' %}
                  Shopify.Cart.DOM.attachSensors(key, updateGiftWrapQuantity, handleRemoveGWBtn);
              {% else %}
                  Shopify.Cart.DOM.attachSensors(key, null, handleRemoveGWBtn);
              {% endif %}
          }

          // If cart drawer enabled, provide callbacks to prevent GiftWrap.set/remove from loading cart page after AJAX call
          {% if settings.show_cart_drawer %}
              var setGiftWrapCb = function () {
                  Shopify.Cart.DOM.addGWItem(insertGWItemToCartDrawer);
              };
              var removeGiftWrapCb = function () {
                  var key = Shopify.Cart.GiftWrap.DOM.getKeyEscaped();
                  Shopify.Cart.DOM.removeGWItem(key);
                  Shopify.Cart.GiftWrap.DOM.reset();
              };
          {% else %}
              var setGiftWrapCb = null;
              var removeGiftWrapCb = null;
          {% endif %}

          // When the gift-wrapping checkbox is checked or unchecked.
          // Note: to prevent double refresh of cart page in following scenario:
          // You start with a state where gift-wrap (GW) is checked and a quantity of GW product in cart.
          // You uncheck the GW checkbox, then you modify the quantities of your products in cart,
          // so that now the total of qty is different from the total qty when GW checkbox was checked.
          // When you then check the GW checkbox again, the cart will refresh and show the GW product reflecting the old total qty.
          // Now, we have the qty of GW product !== current total qty of products. This will trigger another cart refresh due to
          // the checks from the above if/elsif/endif block.
          // The change consists of performing a recount of total qty of items before setting the GW qty.
          jQuery(SELECTORS.gift_wrap_checkbox).change(function checkboxCb() {
              if (jQuery(this).prop('checked')) {
                  {% if settings.gift_wrapping_cost_model == 'per_item' %}
                      var gwKey = Shopify.Cart.GiftWrap.DOM.getKey();
                      Shopify.Cart.GiftWrap.set(Shopify.Cart.countNoGW(gwKey), setGiftWrapCb);
                  {% else %}
                      Shopify.Cart.GiftWrap.set(1, setGiftWrapCb);
                  {% endif %}
              }
              else {
                  Shopify.Cart.GiftWrap.remove(removeGiftWrapCb);
              }
          });

          jQuery('#gift-note').on('change', function saveGWNote() {
              var quantity  = jQuery(SELECTORS.gift_wrap_checkbox).prop('checked') ? Shopify.Cart.GiftWrap.getQuantity() : 0;
              var note      = jQuery(this).val();
              jQuery.ajax({
                  method: 'POST',
                  url: '/cart/update.js',
                  data: { updates: { {{ id }}: quantity }, attributes: { 'gift-note': note } },
                dataType: 'json'
              });
          })
      });
  </script>
{% else %}
  <p style="clear: left; margin: 30px 0" class="rte">
    You attempted to add a gift-wrapping script to your shopping cart, but it won't work because you don't have
    a link list with handle <code>gift-wrapping</code> which, in turn, contains a link
    to your gift-wrapping product. Please review the steps outlined
    <a href="http://docs.shopify.com/manual/configuration/store-customization/page-specific/cart-page/add-a-gift-wrap-option">here</a>.
  </p>
{% endif %}

